<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式架构图生成器</title>
    <!-- 引入 SortableJS 库 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- 引入 Marked.js 用于解析Markdown -->
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/12.0.2/marked.min.js"></script>
    <!-- 基础样式 -->
    <link rel="stylesheet" href="themes/base.css">
    <!-- 主题样式 - 动态加载 -->
    <link id="theme-css" rel="stylesheet" href="themes/default.css">
</head>
<body>
    <header class="main-header">
        <h1>交互式架构图生成器</h1>
        <div class="theme-selector">
            <label for="theme-select">主题:</label>
            <select id="theme-select">
                <!-- 主题选项将通过JavaScript动态生成 -->
            </select>
        </div>
    </header>
    <main class="main-container">
        <div class="panel panel-controls">
            <h2>输入结构</h2>
            <textarea id="input-textarea" placeholder="使用 # 定义层级, - 定义项目..."></textarea>
            
            
            
            <h2>操作</h2>
            <button class="button" id="generate-btn">生成 / 更新图表</button>
            <button class="button" id="export-btn">导出HTML文件</button>

            <h2>设置</h2>
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; margin-bottom: 8px;">
                    <input type="checkbox" id="show-structure-toggles" checked>
                    显示结构层布局按钮
                </label>
                <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; margin-bottom: 8px;">
                    <input type="checkbox" id="hide-outlines">
                    不显示轮廓线
                </label>
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 4px;">字体和字号设置:</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="font-family" style="flex: 2; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                            <!-- 字体选项将通过JavaScript动态生成 -->
                        </select>
                        <select id="font-size" style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="12">12px</option>
                            <option value="14" selected>14px</option>
                            <option value="16">16px</option>
                            <option value="18">18px</option>
                            <option value="20">20px</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 4px;">全局边距倍数:</label>
                    <input type="range" id="global-spacing" min="0.5" max="3" step="0.1" value="1" style="width: 100%;">
                    <div style="text-align: center; font-size: 12px; color: #666; margin-top: 2px;">
                        <span id="global-spacing-value">1.0</span>x
                    </div>
                </div>
                
                <div style="margin-bottom: 8px;">
                    <label style="display: block; font-size: 14px; margin-bottom: 4px;">分项倍数设置:</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 2px;">内边距:</label>
                            <input type="range" id="padding-multiplier" min="0.5" max="3" step="0.1" value="1" style="width: 100%;">
                            <div style="text-align: center; color: #666;">
                                <span id="padding-value">1.0</span>x
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 2px;">外边距:</label>
                            <input type="range" id="margin-multiplier" min="0.5" max="3" step="0.1" value="1" style="width: 100%;">
                            <div style="text-align: center; color: #666;">
                                <span id="margin-value">1.0</span>x
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 2px;">边框:</label>
                            <input type="range" id="border-multiplier" min="0.5" max="3" step="0.1" value="1" style="width: 100%;">
                            <div style="text-align: center; color: #666;">
                                <span id="border-value">1.0</span>x
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 2px;">圆角:</label>
                            <input type="range" id="border-radius-multiplier" min="0" max="3" step="0.1" value="1" style="width: 100%;">
                            <div style="text-align: center; color: #666;">
                                <span id="border-radius-value">1.0</span>x
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h2>📖 语法指南</h2>
            <div class="syntax-guide">
                <p style="margin-bottom: 12px; font-style: italic;">Structura 的语法旨在简单直观。</p>
                
                <details style="margin-bottom: 8px;" open>
                    <summary>基础结构语法</summary>
                    <div>
                        <p class="syntax-description">只有两种基础语法：<code>#</code> 和 <code>-</code>。掌握这两种就够应付 <strong>80%</strong> 以上场景了！</p>
                        <p><code># 标题</code> - 创建一个顶级模块</p>
                        <p><code>## 标题</code>, <code>### 标题</code>... - 创建一个子模块（最多10级），嵌套进离自己最近的前一个母块里。可以循环嵌套</p>
                        <p><code>##</code> (无标题) - 创建一个不可见的隐形容器，可以作为一个不可见的母级使用，用于实现"一横两纵"这种复杂排布</p>
                        <p><code>- 文本项</code> - 在模块内创建一个简单的文本项</p>
                    </div>
                </details>
                
                <details>
                    <summary>侧边栏语法</summary>
                    <div>
                        <p class="syntax-description">有时候，日志模块需要显示在一侧，贯穿其他模块。所以我们引入了 <code>|</code> 语法。<br>其实用不带标题的 <code>##</code> 结构块也可以实现这个效果，但是侧边块语法更加方便，也比 <code>##</code> 结构块更窄。</p>
                        <p><code>##| 标题</code> - 创建左侧边栏块</p>
                        <p><code>## 标题 |</code> - 创建右侧边栏块</p>
                    </div>
                </details>
                
                <details>
                    <summary>块属性语法</summary>
                    <div>
                        <p class="syntax-description">
                            • 有时候我们想直接在代码里控制块是横排还是纵排<br>
                            • 有时候我们想修改块的颜色<br>
                            • 有时候我们想给块起个名字（用来拉箭头）<br>
                            • 所以我们引入了 <code>:</code> 语法和 <code>{}</code> 语法
                        </p>
                        <p><code>## 标题 :my-id</code> - 为块设置自定义ID</p>
                        <p><code>## 标题 r:</code> - 应用横向布局</p>
                        <p><code>## 标题 c:</code> - 应用纵向布局</p>
                        <p><code>## 标题 c:my-id</code> - 同时设置ID并应用纵向布局</p>
                        <p><code>## 标题 {style="background-color: red;"}</code> - 为块应用自定义CSS样式。这里填写的style属性会直接添加到块的style属性中</p>
                        <p><code>## 标题 c:my-id {style="background-color: red;"}</code> - 同时应用上面的所有功能</p>
                        <p><code>## 标题 {id=my-id, layout=c, style="background-color: red;"}</code> - 其实类似 <code>c:my-id</code> 这种语法是 <code>{}</code> 语法的语法糖。所以，我们其实可以直接在 <code>{}</code> 语法中完成所有事情</p>
                    </div>
                </details>
                
                <details>
                    <summary>内容块语法</summary>
                    <div>
                        <p class="syntax-description">有没有可能，在内容块里面写Markdown呢？<br>我们引入了 <code>```</code> 语法。另外，为了方便写注释，我们还引入了 <code>//</code> 语法。</p>
                        <p><code>```文本块 ```</code> - 创建可以跨行的纯文本块</p>
                        <p><code>```md # 标题 ```</code> - 创建跨越多行的Markdown渲染内容块</p>
                        <p><code>//</code> - 添加注释（不在输出中显示）</p>
                    </div>
                </details>
            </div>

        </div>
        <div class="panel panel-preview">
            <h2>交互式预览</h2>
            <div id="diagram-output"></div>
        </div>
        <div class="panel panel-code">
            <h2>生成的代码</h2>
            <pre id="code-preview"><code>点击“生成”按钮以显示代码...</code></pre>
        </div>
    </main>

    <!-- 引入模块化脚本 -->
    <script src="core/config.js"></script>
    <script src="core/ast.js"></script>
    <script src="core/render.js"></script>
    <script src="core/main.js"></script>
    
    <script>
        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            // 创建管理器实例
            const astParser = new ASTParser();
            const renderer = new Renderer();
            const configManager = new ConfigManager();
            const mainManager = new MainManager();
            
            // 设置依赖关系
            mainManager.setDependencies(astParser, renderer, configManager);
            
            // 初始化各个管理器
            await configManager.initialize();
            await renderer.initialize();
            await mainManager.initialize();
            
            // 设置默认输入内容
            const inputTextArea = document.getElementById('input-textarea');
            inputTextArea.value = `# 前端层{layout=r}
## React/Vue前端
- 学生和教师界面
## Swagger UI文档
- FastAPI自动生成课程 API 文档
## 移动端应用
- 学习助手 · 待开发

# 后端层

## API路由层{layout=c}

### 
#### 中间件
##### CORS
##### JWT验签
##### JWT解析
##### 错误捕获

#### 依赖注入
##### 时区转换
##### 多租户session分流

### 路由模块 [事务提交]
#### 认证
-  /api/v1/auth  
#### 课程
- /api/v1/course
#### 用户
- /api/v1/users
#### 成绩
- /api/v1/grades
#### AI Tutor
- /api/v1/tutor
#### ......

## 业务服务层
### 公共服务{style="background-color: #89e6e1"}
- 租户验证
- [访问public schema]
### 认证服务
- JWT管理/登录注册  
### 课程服务
- 课程 CRUD/筛选
### 用户服务
- 学生/教师资料管理
### 成绩服务
- 考试成绩统计/指标
### AI Tutor 服务
- 作业批改/学习建议
### 待办服务
- 任务管理
### ......

## Agent功能层{layout=c}

### Agent
#### 工作流模式 - 节约token·效果稳定
##### 作业批改Agent
- 批量模式
##### 学习报告分析Agent
##### ......
#### Agent模式 - 功能强大·自由度高
##### 课程推荐Agent
##### 风险监测Agent
##### 学习答疑Agent
- 即时问答模式
##### ......

###
#### Agent工具
##### 联网搜索
##### 网页浏览
##### 文件下载
##### 知识检索
##### 相似检索
##### ....

#### MCP C/S
##### 本地 MCP Server
##### 云端 MCP Server
##### 本地 MCP Client

#### 知识库
##### 知识导入
##### 知识管理
##### 知识编排
##### 层级构建

### 模型管理
- AzureOpenAI · Qwen · ChatGLM · Kimi · Claude · OpenAI · Doubao · ......
#### LLMs/MultiModal-LLMs
#### Embeddings
#### Reranks
#### ASR
#### TTS
#### ......

##
### 外部集成层
#### 邮件适配器
- Microsoft Graph
- IMAP/POP3
- ...
#### IM软件适配器
- 企业微信
- 飞书
- ...
#### 教育系统适配器
- Blackboard
- Moodle
- ...
#### Agent适配器
- Dify
- n8b
- ...

### 异步任务层
- Celery Worker
#### 定时任务
##### 成绩计算
##### 数据同步
##### 报表生成
#### 异步任务
##### Agent任务
##### 作业批改
##### 学习分析

## 数据访问层

### Repository模式
- 对象关系映射 · 业务逻辑 · 事务管理
#### 课程repo
#### 公共repo
#### 用户repo
#### ......

### ORM模型
- SQLAlchemy 2.0 · 区分schema · 支持Alembic迁移
#### 用户模型
#### 课程模型
#### 成绩模型
#### ......

## 日志层 {layout=c}|
### 组件化绑定
- 区分模块
### 异步日志
- 避免阻塞事件循环
### 捕获 logging
- 捕获三方库日志
- 捕获子模块日志
### 文件配置
- 4 MB 轮转
- 30 天保留
- zip 存档
### 日志级别热切换
- 方便调试
### 协程崩溃捕获
- 防止"任务静默失败"

## 数据存储层
### PostgreSQL
- 主数据库
- 多租户Schema级强隔离
### MongoDB
- 存储课件文件
- 存储低热持久大集合
### Redis
- 缓存/会话
- JWT黑名单
- Celery
### Alembic
- 数据库迁移
- 版本管理
- 租户创建

# 部署层{layout=r}
## Docker
- 所有组件容器化
- 自动初始化数据库
- 自动初始化测试租户
- 自动初始化测试用户
## Docker Compose
- 便捷部署
## Nginx
- 支持API挂载
`;
            
            // 首次进入网页自动触发一次渲染
            setTimeout(() => {
                mainManager.generateAndRender();
            }, 100);
        });
    </script>
</body>
</html>

